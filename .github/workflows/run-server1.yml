name: â›ï¸ Minecraft Server Runner

# This workflow will be manually triggered from the Actions tab
on:
  workflow_dispatch:
    inputs:
      playit_secret:
        description: 'Your Playit.gg secret key to create the tunnel.'
        required: true
        type: string

jobs:
  run-minecraft:
    # Use a high-end runner (ubuntu-latest is fine for basic tests)
    runs-on: ubuntu-latest
    timeout-minutes: 360 # Max runtime is 6 hours (360 minutes)

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Install Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: ğŸŒ Start Playit.gg Tunnel in Background
        # We ensure the variables are handled correctly by using the 'exec' format
        run: |
          # 1. Download the raw executable binary and save it as 'playit'
          curl -sL https://github.com/playit-cloud/playit-agent/releases/download/v0.16.5/playit-linux-amd64 -o playit
          
          # 2. Make the file executable
          chmod +x playit
          
          # 3. Start the tunnel using the variable, wrapped in double quotes for safety
          # We run it in the background using 'nohup' to ensure it keeps running
          nohup ./playit -s "${{ github.event.inputs.playit_secret }}" --start-all > playit.log 2>&1 &
          
          # Give it a moment to stabilize
          echo "Playit client started in background."
          sleep 15
          
          # Check for a successful startup log entry
          if grep -q "Started tunnel" playit.log; then
              echo "âœ… Tunnel confirmed to be running!"
          else
              echo "âš ï¸ Tunnel failed to start correctly. Check playit.log below."
          fi
          
          # 4. Output the tunnel details
          cat playit.log

      - name: ğŸš€ Start Minecraft Server
        # The 'timeout' command limits how long the server runs to ensure 
        # the server shuts down before the 6-hour GitHub Actions limit.
        # Here it's set to 5 hours (300 minutes), giving 1 hour buffer.
        run: |
          echo "Starting Minecraft Server..."
          timeout 300m java -Xmx4G -Xms4G -jar server.jar nogui
          echo "Minecraft Server process ended."
          
      - name: ğŸ§¹ Cleanup (Optional)
        # Here is where you would commit/push your world files back to the repo,
        # or upload them to an external cloud storage (like S3) if needed.
        run: echo "Server stopped. World data is volatile unless explicitly saved/uploaded."
