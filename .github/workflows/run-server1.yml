name: ‚õèÔ∏è Minecraft Server Runner

# This workflow will be manually triggered from the Actions tab
on:
  workflow_dispatch:
    inputs:
      playit_secret:
        description: 'Your Playit.gg secret key to create the tunnel.'
        required: true
        type: string

jobs:
  run-minecraft:
    # Use a high-end runner (ubuntu-latest is fine for basic tests)
    runs-on: ubuntu-latest
    timeout-minutes: 360 # Max runtime is 6 hours (360 minutes)

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: ‚òï Install Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: üåê Start Playit.gg Tunnel in Background
        env:
          # Securely pass the secret key as an environment variable (PLAYIT_SECRET_KEY)
          PLAYIT_SECRET_KEY: ${{ github.event.inputs.playit_secret }}
        run: |
          # 1. Download the raw executable binary and save it as 'playit'
          curl -sL https://github.com/playit-cloud/playit-agent/releases/download/v0.16.5/playit-linux-amd64 -o playit
          
          # 2. Make the file executable
          chmod +x playit
          
          # 3. Start the tunnel using the environment variable, which the playit agent SHOULD recognize.
          # Note: We omit the '-s' flag and let the agent read the key from the environment.
          nohup ./playit connect > playit.log 2>&1 &
          
          # Give it a moment to stabilize
          echo "Playit client started in background."
          sleep 15
          
          # Wait for the agent to establish a connection (this message indicates success)
          echo "Checking Playit agent status..."
          
          # Look for the successful connection message in the logs
          if grep -q "Starting tunnel" playit.log; then
              echo "‚úÖ Tunnel confirmed to be running!"
              # Output log content for the IP address
              cat playit.log
          else
              echo "‚ö†Ô∏è Tunnel failed to start correctly. Check playit.log below."
              cat playit.log
              # Exit the job if the tunnel failed, as the server is unreachable anyway
              exit 1 
          fi

      - name: üöÄ Start Minecraft Server
        # The 'timeout' command limits how long the server runs to ensure 
        # the server shuts down before the 6-hour GitHub Actions limit.
        # Here it's set to 5 hours (300 minutes), giving 1 hour buffer.
        run: |
          echo "Starting Minecraft Server..."
          timeout 300m java -Xmx4G -Xms4G -jar server.jar nogui
          echo "Minecraft Server process ended."
          
      - name: üßπ Cleanup (Optional)
        # Here is where you would commit/push your world files back to the repo,
        # or upload them to an external cloud storage (like S3) if needed.
        run: echo "Server stopped. World data is volatile unless explicitly saved/uploaded."
